package dev.kizuna.mod.modules.impl.exploit;

import dev.kizuna.api.events.eventbus.EventHandler;
import dev.kizuna.api.events.impl.PacketEvent;
import dev.kizuna.api.events.impl.TickEvent;
import dev.kizuna.api.events.Event;
import dev.kizuna.mod.modules.Module;
import net.minecraft.network.packet.s2c.play.PlayerPositionLookS2CPacket;
import net.minecraft.network.packet.s2c.play.DeathMessageS2CPacket;
import net.minecraft.network.packet.c2s.play.TeleportConfirmC2SPacket;
import net.minecraft.util.math.Vec3d;

public class DeathTP extends Module {
	private Vec3d deathPos;

	public DeathTP() {
		super("DeathTP", Module.Category.Exploit);
		setChinese("死亡传送");
	}

	@EventHandler
	private void onTick(TickEvent event) {
		if (event.getStage() != Event.Stage.Post) return;
		
		if (mc.player != null && mc.player.getHealth() <= 0 && deathPos == null) {
			deathPos = new Vec3d(mc.player.getX(), mc.player.getY(), mc.player.getZ());
		}
	}

	@EventHandler
	private void onReceivePacket(PacketEvent.Receive event) {
		if (deathPos != null && event.getPacket() instanceof PlayerPositionLookS2CPacket packet) {
			event.cancel();

			mc.player.networkHandler.sendPacket(
				new TeleportConfirmC2SPacket(packet.getTeleportId())
			);

			mc.player.setPosition(deathPos.x, deathPos.y, deathPos.z);
		}

		if (event.getPacket() instanceof DeathMessageS2CPacket) {
			event.cancel();
		}
	}

	public void onDisable() {
		deathPos = null;
	}
}